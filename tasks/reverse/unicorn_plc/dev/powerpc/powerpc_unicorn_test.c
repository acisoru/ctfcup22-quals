#include <unicorn/unicorn.h>
#include <string.h>
#include <stdio.h>

#define PPC64CODE "\x91\x3f\x00\x0c\x81\x3f\x00\x0c\x55\x29\x46\x3e\x55\x29\x06\x3e\x99\x3f\x00\x10\x81\x3f\x00\x0c\x7d\x29\x86\x70\x55\x29\x06\x3e\x99\x3f\x00\x11\x81\x3f\x00\x0c\x7d\x29\x46\x70\x55\x29\x06\x3e\x99\x3f\x00\x12\x81\x3f\x00\x0c\x55\x29\x06\x3e\x99\x3f\x00\x13\x3d\x20\x4a\x11\x61\x29\xc0\xef\x91\x3f\x00\x14\x3d\x20\x90\xba\x61\x29\x13\x02\x91\x3f\x00\x18\x39\x20\x00\x00\x91\x3f\x00\x08\x48\x00\x00\x60\x39\x5f\x00\x18\x81\x3f\x00\x08\x7d\x2a\x4a\x14\x89\x49\x00\x00\x39\x1f\x00\x10\x81\x3f\x00\x08\x7d\x28\x4a\x14\x89\x29\x00\x00\x7d\x2a\x49\xd6\x55\x2a\x06\x3e\x39\x1f\x00\x14\x81\x3f\x00\x08\x7d\x28\x4a\x14\x89\x29\x00\x00\x7d\x2a\x4a\x14\x55\x2a\x06\x3e\x39\x1f\x00\x10\x81\x3f\x00\x08\x7d\x28\x4a\x14\x99\x49\x00\x00\x81\x3f\x00\x08\x39\x29\x00\x01\x91\x3f\x00\x08\x81\x3f\x00\x08\x2c\x09\x00\x03\x40\x81\xff\x9c\x89\x3f\x00\x10\x28\x09\x00\x0a\x40\x82\x00\x50\x89\x3f\x00\x11\x28\x09\x00\xdf\x40\x82\x00\x44\x89\x3f\x00\x12\x69\x29\x00\xd5\x7d\x29\x00\x34\x55\x29\xd9\x7e\x55\x2a\x06\x3e\x89\x3f\x00\x13\x69\x29\x00\x3b\x7d\x29\x00\x34\x55\x29\xd9\x7e\x55\x29\x06\x3e\x7d\x49\x48\x38\x55\x29\x06\x3e\x2c\x09\x00\x00\x41\x82\x00\x0c\x39\x20\x00\x01\x48\x00\x00\x08\x39\x20\x00\x00\x39\x00\x00\x00"

#define ADDRESS 0x00000000

static void hook_code(uc_engine *uc, uint64_t address, uint32_t size, void *user_data)
{
    int r8,r9;
    uc_reg_read(uc, UC_PPC_REG_8, &r8);
    uc_reg_read(uc, UC_PPC_REG_9, &r9);
    printf("\t[!] addr=0x%" PRIx64 ", opcode size = 0x%x,  r8=0x%x,  r9=0x%x\n",
           address, size, r8, r9);
}

void uc_mips_start()
{
    uc_engine* uc;
    uc_err err;
    uc_hook hook_d;
    err = uc_open(UC_ARCH_PPC, UC_MODE_PPC32 + UC_MODE_BIG_ENDIAN, &uc);
    if (err)
    {
        printf("[-] Can't create Emulator: %u %s\n", err, uc_strerror(err));
        return;
    }
    printf("[+] Emulator init\n");

    //int r9 = 0xaabbccdd;
    int r9 = 0x9c1337a6;
    int r31 = 2*1024;
    
    uc_mem_map(uc, ADDRESS, 2*1024*1024, UC_PROT_ALL);
    uc_mem_write(uc, ADDRESS, PPC64CODE, sizeof(PPC64CODE)-1);
    uc_reg_write(uc, UC_PPC_REG_9, &r9); 
    uc_reg_write(uc, UC_PPC_REG_31, &r31); 
    uc_hook_add(uc, &hook_d, UC_HOOK_CODE, hook_code, NULL, ADDRESS, ADDRESS+sizeof(PPC64CODE)-1);
    printf("[+] Emulator configured\n");

    err = uc_emu_start(uc, ADDRESS, ADDRESS+sizeof(PPC64CODE)-1, 0,0);
    if (err)
    {
        printf("[-] Emulation fucked up: %u %s\n", err, uc_strerror(err));
        return;
    }
    printf("[+] Emulator done!\n");
    uc_reg_read(uc, UC_PPC_REG_9, &r9);
    printf("r9 = 0x%x\n", r9);

    uc_close(uc);

}


int main()
{
    uc_mips_start();

    return 0;
}